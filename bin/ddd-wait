#!/bin/bash
# ddd-wait: Project Local Client
# Usage: DDD_TIMEOUT=60 ./ddd-wait

# Find .ddd relative to this script (assuming this script is inside .ddd/wait)
# If invoked from tools/ddd/bin/ddd-wait, we need to handle that too, 
# but mostly this is for the injected copy.
DDD_DIR=".ddd"
if [ ! -d "$DDD_DIR" ]; then
    # Fallback if running from source location
    if [ -d "../../.ddd" ]; then DDD_DIR="../../.ddd"; fi
fi

RUN_DIR="$DDD_DIR/run"
TRIGGER="$RUN_DIR/build.request"
LOCK="$RUN_DIR/ipc.lock"
LOG="$RUN_DIR/build.log"

if [ ! -d "$DDD_DIR" ]; then
    echo "Error: .ddd directory not found in $(pwd)."
    exit 1
fi

# Ensure Run Dir exists (Daemon should make it, but safety first)
mkdir -p "$RUN_DIR"

TIMEOUT_SEC="${DDD_TIMEOUT:-60}"
SLEEP_INT=0.2
MAX_RETRIES=$((TIMEOUT_SEC * 5))

# 1. Trigger
touch "$TRIGGER"
echo "[ddd] Build triggered. Waiting (Timeout: ${TIMEOUT_SEC}s)..."

# 2. Wait for Start (Lock Appears)
for i in {1..20}; do
    if [ -f "$LOCK" ]; then break; fi
    sleep 0.1
done

# 3. Wait for Finish (Lock Vanishes)
count=0
while [ -f "$LOCK" ]; do
    if [ $count -ge $MAX_RETRIES ]; then
        echo "Error: Build timed out (> ${TIMEOUT_SEC}s) or daemon crashed."
        exit 1
    fi
    sleep $SLEEP_INT
    count=$((count+1))
done

# 4. Show Result
echo "---------------------------------------------------"
if [ -f "$LOG" ]; then
    cat "$LOG"
else
    echo "Error: No build log found at $LOG"
fi
echo "---------------------------------------------------"

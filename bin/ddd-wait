#!/bin/bash
# ddd-wait: Project Local Client (Strict Mode)
# Usage: DDD_TIMEOUT=60 ./ddd-wait

DDD_DIR=".ddd"
if [ ! -d "$DDD_DIR" ]; then
    # Fallback to parent if running inside a subdir
    if [ -d "../../.ddd" ]; then DDD_DIR="../../.ddd"; fi
fi

RUN_DIR="$DDD_DIR/run"
TRIGGER="$RUN_DIR/build.request"
LOCK="$RUN_DIR/ipc.lock"
LOG="$RUN_DIR/build.log"

if [ ! -d "$DDD_DIR" ]; then
    echo "Error: .ddd directory not found in $(pwd)."
    exit 1
fi

# Ensure run directory exists
mkdir -p "$RUN_DIR"

TIMEOUT_SEC="${DDD_TIMEOUT:-60}"
SLEEP_INT=0.2
MAX_RETRIES=$((TIMEOUT_SEC * 5))

# 1. Trigger
touch "$TRIGGER"
echo "[ddd] Build triggered. Waiting for Daemon (Timeout: ${TIMEOUT_SEC}s)..."

# 2. Wait for Start (Lock Appears) - STRICT CHECK
LOCK_ACQUIRED=0
# Wait up to 2 seconds for the daemon to pick it up
for i in {1..20}; do
    if [ -f "$LOCK" ]; then 
        LOCK_ACQUIRED=1
        break
    fi
    sleep 0.1
done

# CRITICAL FIX: If no lock appeared, the daemon is dead. Fail immediately.
if [ $LOCK_ACQUIRED -eq 0 ]; then
    echo "âŒ Error: Daemon did not respond. Is 'dd-daemon' running?"
    exit 1
fi

# 3. Wait for Finish (Lock Vanishes)
count=0
while [ -f "$LOCK" ]; do
    if [ $count -ge $MAX_RETRIES ]; then
        echo "Error: Build timed out (> ${TIMEOUT_SEC}s)."
        exit 1
    fi
    sleep $SLEEP_INT
    count=$((count+1))
done

# 4. Show Result
echo "---------------------------------------------------"
if [ -f "$LOG" ]; then
    cat "$LOG"
else
    echo "Error: No build log found at $LOG"
fi
echo "---------------------------------------------------"
